{% extends '@Cequens/Admin/layout.html.twig' %}

{% block css %}
    {{ parent() }}
    <link href="{{ asset('bundles/cequens/plugins/bootstrap3-wysihtml5/bootstrap3-wysihtml5.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('bundles/cequens/plugins/bootstrap-tag/bootstrap-tagsinput.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('bundles/cequens/plugins/jquery-menuclipper/jquery.menuclipper.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('bundles/cequens/css/jquery.atwho.css') }}" rel="stylesheet" type="text/css"/>
    <style>
        .chat-view .chat-bubble {
            padding: 0px !important;
        }

        .chat-view .chat-inner {
            height: calc(100% - 55px);
        }
        .controllers-wrapper{
        }
        .remove-me{
            margin: 20px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="full-height">
        <nav class="secondary-sidebar light">
            <div class=" m-b-30 m-l-30 m-r-30 hidden-sm-down">
                <select class="custom-select" id="currentBot" name="currentBot">
                    <option value="all">Applications</option>
                    {% for bot in bots %}
                        <option value="{{ bot.id }}">{{ bot.botName }}</option>
                    {% endfor %}
                </select>
            </div>
            <p class="menu-title">Inbox</p>
            <ul class="main-menu">
                <li class="active">
                    <a href="#">
                        <span class="title"><i class="pg-inbox"></i> Assigned</span>
                        <span class="badge pull-right assigned_counter">0</span>
                    </a>
                </li>
                <li class="">
                    <a href="#">
                        <span class="title"><i class="pg-folder"></i> Unassigned</span>
                        <span class="badge pull-right unassigned_counter">0</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="title"><i class="pg-sent"></i> Closed</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="inner-content full-height">
            <div class="split-view">
                <div class="split-list">
                    <div class="row-fluid">
                        <div class="">
                            <a class="list-refresh" href="#"><i class="fa fa-refresh"></i></a>
                        </div>
                    </div>
                    <div data-email="list" class="list-view boreded no-top-border">

                    </div>
                </div>
                <div data-email="opened" class="split-details">
                    <div class="no-result">
                        <h1>No conversation has been selected</h1>
                    </div>
                    <div class="view-port clearfix full-height" id="chat" style="background-color: #e7e7e7;width: auto;max-height: 65%;display: none;">
                        <div class="view chat-view bg-white clearfix">
                            <div class="navbar navbar-default">
                                <div class="navbar-inner">
                                    <div class="view-heading">
                                        <div class="actions-wrapper menuclipper bg-master-lightest">
                                            <ul class="actions menuclipper-menu no-margin p-l-20 p-t-5">
                                                <li class="hidden-lg-up">
                                                    <a href="#" class="split-list-toggle"><i class="fa fa-angle-left"></i> Unassigned</a>
                                                </li>
                                                <li class="">
                                                    <label class="input-group-text text-info" for="conversationStatus">Status: </label>
                                                    <select class="custom-select" id="conversationStatus">
                                                        <option value="open" selected>Open</option>
                                                        <option value="close">Close</option>
                                                        <option value="span">Span</option>
                                                        <option value="duplicate">Duplicate</option>
                                                    </select>
                                                </li>
                                                <li class="">
                                                    <label class="input-group-text text-info" for="inputGroupSelect01">Assign
                                                        To: </label>
                                                    <select class="custom-select" id="inputGroupSelect01">
                                                        <option selected>K.mohamed</option>
                                                        <option value="1">Adham (Bot)</option>
                                                    </select>

                                                </li>
                                            </ul>
                                            <div class="clearfix"></div>
                                        </div>
                                    </div>
                                    <a href="#" class="link text-master inline action p-r-10 pull-right ">
                                        <i class="pg-more"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="chat-inner">

                            </div>
                        </div>
                    </div>
                    <div class="row-fluid p-t-5" style="display: none;" id="sendMessage">
                        <div id = "typingindicator" style="visibility: hidden" align="right">   typing <img width="25"  height="25" src="https://loading.io/spinners/message/lg.messenger-typing-preloader.gif"></div>
                        <div class="col-md-12">
                            <div class="card card-transparent">
                                <ul class="nav nav-tabs nav-tabs-linetriangle" data-init-reponsive-tabs="dropdownfx">
                                    <li class="nav-item">
                                        <a href="#" class="active" data-toggle="tab"
                                           data-target="#fade1"><span>Chat</span></a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#" data-toggle="tab" data-target="#fade3"><span>Insights</span></a>
                                    </li>
                                </ul>
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="fade1">
                                        <div class="row column-seperation">
                                            <div class="col-lg-12">
                                                <form class="form" id="sendMessageFromAgent"
                                                      name="sendMessageFromAgent">
                                                    <input type="hidden" id="bot_id" value="">
                                                    <input type="hidden" id="user_id" value="">
                                                    <div class="form-group basic-textarea">
                                                        <textarea class="form-control pl-2 my-0"
                                                                  style="height: 90px;min-height: 90px;"
                                                                  id="exampleFormControlTextarea2" rows="3"
                                                                  placeholder="Type your message here..."></textarea>
                                                    </div>

                                                    <div>

                                                        <div class="controllers-wrapper">
                                                            <div>
                                                                <button type="submit" id="btn_sendMessage"
                                                                        class="btn btn-danger btn-cons btn-animated from-left pg pg-mail">
                                                                    <span>Send</span>
                                                                </button>
                                                            </div>

                                                            <div>
                                                                <ul class="nav nav-tabs" id="myTab" role="tablist">
                                                                    {#                                                                    <li class="nav-item">#}
                                                                    {#                                                                        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#inputText" role="tab" aria-controls="home"#}
                                                                    {#                                                                           aria-selected="true">text</a>#}
                                                                    {#                                                                    </li>#}
                                                                    <li class="nav-item">
                                                                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#inputListtext" role="tab" aria-controls="profile"
                                                                           aria-selected="false">List Picker</a>
                                                                    </li>
                                                                    <li class="nav-item">
                                                                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#inputListimage" role="tab" aria-controls="profile"
                                                                           aria-selected="false">List Picker image</a>
                                                                    </li>
                                                                    <li class="nav-item">
                                                                        <a class="nav-link" id="contact-tab" data-toggle="tab" href="#timePicker" role="tab" aria-controls="contact"
                                                                           aria-selected="false">Time Picker</a>
                                                                    </li>
                                                                    <li class="nav-item">
                                                                        <a class="nav-link" id="contact-tab" data-toggle="tab" href="#inputAttach" role="tab" aria-controls="contact"
                                                                           aria-selected="false">attachment</a>
                                                                    </li>
                                                                    <li class="nav-item">
                                                                        <a class="nav-link" id="contact-tab" data-toggle="tab" href="#inputApplePay" role="tab" aria-controls="contact"
                                                                           aria-selected="false">apple pay</a>
                                                                    </li>
                                                                </ul>
                                                                <div class="tab-content" id="myTabContent">
                                                                    {#                                                                    <div class="tab-pane fade show active" id="inputText" role="tabpanel" aria-labelledby="home-tab">#}
                                                                    {#                                                                        <form>#}
                                                                    {#                                                                            <input type="text" id="b5">#}
                                                                    {#                                                                            <button type="submit" onclick="sendText()">send</button>#}
                                                                    {#                                                                        </form>#}
                                                                    {#                                                                    </div>#}
                                                                    <div class="tab-pane fade active" id="inputListtext" role="tabpanel" aria-labelledby="profile-tab">

                                                                        <div class="col-xs-12">
                                                                            <div class="col-md-12" >
                                                                                {#                                                                                <h3> Actions</h3>#}
                                                                                <div id="field">
                                                                                    <div id="field0">
                                                                                        <!-- Text input-->
                                                                                        <div class="form-group">
                                                                                            <label class="col-md-4 control-label" for="action_id">Section Title</label>
                                                                                            <div class="col-md-5">
                                                                                                <input id="section_title" name="action_id" type="text" placeholder="" class="form-control input-md">

                                                                                            </div>
                                                                                        </div>
                                                                                        <br><br>
                                                                                        <!-- Text input-->
                                                                                        <div class="form-group">
                                                                                            <label class="col-md-4 control-label" for="action_id">Item Title</label>
                                                                                            <div class="col-md-5">
                                                                                                <input id="item_title" name="action_id" type="text" placeholder="" class="form-control input-md">

                                                                                            </div>
                                                                                        </div>
                                                                                        <br><br>
                                                                                        <!-- Text input-->
                                                                                        <div class="form-group">
                                                                                            <label class="col-md-4 control-label" for="action_name">Item Subtitle</label>
                                                                                            <div class="col-md-5">
                                                                                                <input id="item_subtitle" name="action_name" type="text" placeholder="" class="form-control input-md">
                                                                                            </div>
                                                                                        </div>
                                                                                        {#                                                                                        <div class="form-group">#}
                                                                                        {#                                                                                            <label class="col-md-4 control-label" for="action_name">Type</label>#}
                                                                                        {#                                                                                            <div class="col-md-5">#}
                                                                                        {#                                                                                                <input id="type" name="action_name" type="text" placeholder="" class="form-control input-md">#}
                                                                                        {#                                                                                            </div>#}
                                                                                        {#                                                                                        </div>#}
                                                                                        {#                                                                                        <br><br>#}
                                                                                        <!-- File Button -->
                                                                                        {#                                                                                        <div class="form-group">#}
                                                                                        {#                                                                                            <label class="col-md-4 control-label" for="action_json">Action JSON File</label>#}
                                                                                        {#                                                                                            <div class="col-md-4">#}
                                                                                        {#                                                                                                <input type="file" id="action_json" name="action_json" class="input-file" accept=".txt,.json">#}
                                                                                        {#                                                                                                <div id="action_jsondisplay"></div>#}
                                                                                        {#                                                                                            </div>#}
                                                                                        {#                                                                                        </div>#}

                                                                                    </div>
                                                                                </div>
                                                                                <!-- Button -->
                                                                                <div class="form-group">
                                                                                    <div class="col-md-4">
                                                                                        <button id="add-more" name="add-more" class="btn btn-primary">Add More</button>
                                                                                    </div>
                                                                                </div>
                                                                                <br><br>
z
                                                                                <button type="submit"  class="list-submit" >send</button>

                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="inputListimage" role="tabpanel" aria-labelledby="profile-tab">

                                                                        <div class="col-xs-12">
                                                                            <div class="col-md-12" >
                                                                                {#                                                                                <h3> Actions</h3>#}
                                                                                <div id="field-with-image">
                                                                                    <div id="field-with-image0">
                                                                                        <div class="form-group">
                                                                                            <label class="col-md-4 control-label" for="action_name">Section Title</label>
                                                                                            <div class="col-md-5">
                                                                                                <input id="section_title" name="action_name" type="text" placeholder="" class="form-control input-md">
                                                                                            </div>
                                                                                        </div>
                                                                                        <br><br>
                                                                                        <!-- Text input-->
                                                                                        <div class="form-group">
                                                                                            <label class="col-md-4 control-label" for="action_id">Item Title</label>
                                                                                            <div class="col-md-5">
                                                                                                <input id="item_title" name="action_id" type="text" placeholder="" class="form-control input-md">

                                                                                            </div>
                                                                                        </div>
                                                                                        <br><br>
                                                                                        <!-- Text input-->
                                                                                        <div class="form-group">
                                                                                            <label class="col-md-4 control-label" for="action_name">Item Subtitle</label>
                                                                                            <div class="col-md-5">
                                                                                                <input id="item_subtitle" name="action_name" type="text" placeholder="" class="form-control input-md">
                                                                                            </div>
                                                                                        </div>

                                                                                        <!-- File Button -->
                                                                                        <div class="form-group">
                                                                                            <label class="col-md-4 control-label" for="action_json">Attachment</label>
                                                                                            <div class="col-md-4">
                                                                                                <input onchange="uploadFile(this)" type="file" id="image" name="action_json" class="input-file list-image"  accept=".png,.jpg,.jpeg">
                                                                                            </div>
                                                                                        </div>

                                                                                    </div>
                                                                                </div>
                                                                                <!-- Button -->
                                                                                <div class="form-group">
                                                                                    <div class="col-md-4">
                                                                                        <button id="add-more-with-images" name="add-more" class="btn btn-primary">Add More</button>
                                                                                    </div>
                                                                                </div>
                                                                                <br><br>

                                                                                <button type="submit"  class="list-image-submit" >send</button>

                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="tab-pane fade" id="timePicker" role="tabpanel" aria-labelledby="contact-tab">
                                                                        <form>

                                                                            <input type="date" class="time-picker" value="2014-02-09">

                                                                            <input type="date"  class="time-picker" value="2014-02-09">

                                                                            <button type="submit"  class="time-picker-submit" >send</button>

                                                                        </form>
                                                                    </div>
                                                                    <div class="tab-pane fade show" id="inputAttach" role="tabpanel" aria-labelledby="home-tab">
                                                                        <form>
                                                                            <div class="form-group">
                                                                                <label class="col-md-4 control-label" for="action_json">Action JSON File</label>
                                                                                <div class="col-md-4">
                                                                                    <input type="text" id="b55" name="action_json" class="input-file"  accept=".png,.jpg,.jpeg">
                                                                                </div>
                                                                            </div>
                                                                            <div>
                                                                                <button type="submit" class="send-attach-submit">send</button>
                                                                            </div>
                                                                        </form>
                                                                    </div>
                                                                    <div class="tab-pane fade show" id="inputApplePay" role="tabpanel" aria-labelledby="home-tab">
                                                                        <div class="col-xs-12">
                                                                            <div class="col-md-12" >
                                                                                <div id="pay"></div>
                                                                                <div class="form-group">
                                                                                    <div class="col-md-4 offset-md-4">
                                                                                        <button id="add-more-pay" name="add-more" class="btn btn-primary">Add More</button>
                                                                                    </div>
                                                                                </div>
                                                                                <br><br>

                                                                                <button type="submit"  class="list-submit-apple-pay" >send</button>

                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>



                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="fade3">
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <div class="container-xs-height">
                                                    <div class="row-xs-height" id="client_details">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block handlebar %}
    {% include ('@Cequens/Admin/pages/Inbox/conversation_handlebars.html.twig') %}
{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script type="text/javascript" src="{{ asset('bundles/cequens/js/inflection.js')}}"></script>
    <script src="{{ asset('bundles/cequens/plugins/bootstrap3-wysihtml5/bootstrap3-wysihtml5.all.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/cequens/plugins/jquery-menuclipper/jquery.actual.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/cequens/plugins/jquery-menuclipper/jquery.menuclipper.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/cequens/plugins/bootstrap-tag/bootstrap-tagsinput.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/cequens/js/timeline.js') }}" type="text/javascript"></script>p
    <script type="text/javascript" src="{{ asset('bundles/cequens/js/handlebars-v4.0.10.js') }}"></script>
    <script src="https://unpkg.com/@pusher/chatkit-client@1.3.1/dist/web/chatkit.js"></script>
    <script src="https://js.pusher.com/4.3/pusher.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://unpkg.com/hyperapp@1.2.0/dist/hyperapp.js"></script>
    <script src="{{ asset('bundles/cequens/js/jquery.timeago.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/cequens/js/jquery.caret.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/cequens/js/jquery.atwho.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/cequens/js/bootbox.min.js') }}" type="application/javascript"></script>
    <script src="{{ asset('bundles/cequens/pages/js/pages.email.js') }}" type="text/javascript"></script>
    {#<script src="../../../../public/js/index.js"></script>#}
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    {#<script>
    function formateListData(e){
        e.preventDefault();
        var data = $('input[type="text"].brb2').each(function () {
                        console.log($(this).val());
                    });
        console.log(data);
    }



    function sendText() {
        var resultElement = document.getElementById('b5').value;
         $.ajax({
            type: 'post',
            url: "http://abc75745.ngrok.io/testbc",
            data: {
                user_id: 'user id',
                message: 'message',
                room_name:'xxx'
            },
            dataType: 'json',
            cache: false,
            timeout: 120000,
            success: function (response) {
                console.log('sucesssss');
                if (response.success) {
                    console.log('SUCCESS YA 3AM ASHRAF XXXX');
                    $('textarea#exampleFormControlTextarea2').removeAttr('disabled');
                    $('#btn_sendMessage').removeAttr('disabled');
                    $('textarea#exampleFormControlTextarea2').val('');
                } else {
                    $('textarea#exampleFormControlTextarea2').removeAttr('disabled');
                    $('#btn_sendMessage').removeAttr('disabled');
                }
            },
            error: function (response) {
                alert('Error while sending msgxxxxx '+JSON.stringify(response) );
                $('textarea#exampleFormControlTextarea2').removeAttr('disabled');
                $('#btn_sendMessage').removeAttr('disabled');
            }
         });
    }
    </script>#}
    <script type="text/javascript">
        var next = 0;
        var nextPay = -1;
        var files = [] ;




        function encodeImagetoBase64(element){
            console.log($('#inputListimage #field0 #image')[0].files[0]);

            var file = element.files[0];

            var reader = new FileReader();

            reader.readAsBinaryString(file);




            console.log(window.btoa(reader.result));

        }

        function sendData(data){
            $.ajax({
                type: 'post',
                url: "http://chatbots2.cequens.net/testbc",
                data: {
                    user_id: 'user id',
                    results: JSON.stringify(data),
                    room_name:'xxx'
                },
                dataType: 'json',
                cache: false,
                timeout: 120000,
                success: function (response) {
                    console.log('sucesssss');
                    if (response.success) {
                        console.log('SUCCESS YA 3AM ASHRAF XXXX');
                    } else {
                        console.log('FAILURE YA 3AM ASHRAF XXXX');
                    }
                },
                error: function (response) {
//                    alert('Error while sending msgxxxxx '+JSON.stringify(response) );
                }
            });
        }

        function generateDataFormat(type){
            var format = {
                type: "interactive",
                interactiveData : {
                    bid: "x",
                    data:{
                        "version": "1.0",
                        requestIdentifier: ""
                    },
                    "receivedMessage": {
                        "style": "small",
                        "subtitle": "Farm fresh to you",
                        "title": "Select Produce"
                    },
                    "replyMessage": {
                        "style": "small",
                        "title": "Selected Produce",
                        "subtitle": "Selected Produce"
                    }
                },
                "sourceId": "BIZ_ID",
                "destinationId": "destination_id",
                "v": 1,
                "id": "message_id"
            };
            switch (type) {

                case "listPicker":
                    format.messageType = "text_listpicker";
                    format.interactiveData.data.listPicker = {
                        multipleSelection : true,
                        sections : []
                    }
                    break;
                case "timePicker":
                    format.messageType = "timepicker";
                    format.interactiveData.data.event = {
                        "identifier": "1",
                        "title": "",
                        "timeslots":[]
                    }
                    break;
                case "applyPay":
                    format.interactiveData.data.payment = {
                        paymentRequest : {
                            lineItems: [],
                            applePay : {
                                merchantIdentifier : "",
                                supportedNetworks : [],
                                merchantCapabilities : []
                            },
                            merchantName:"",
                            countryCode : "",
                            currencyCode : ""
                        }
                    }
                    break
            };
            return format;
        }


        function formateDataTimePicker(data){

            var dataformatted = generateDataFormat("timePicker");

            for(var i =0; i < data.length ; i++){
                var slot = {
                    duration: 3600,
                    startTime: data[i],
                    identifier: i+""
                }
                dataformatted.interactiveData.data.event.timeslots.push(slot);
            }

            return dataformatted;

        }

        function uploadFile(element){
            console.log('uploading file .... ');
            var file = element.files[0];
            if(file != undefined){
                console.log('file is un defined');
                formData= new FormData();
                if(!!file.type.match(/image.*/)){
                    formData.append("image", file);
                    return $.ajax({
                        url: "http://chatbots2.cequens.net/testupload?fileName="+file.name,
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        // success: function(data){
                        //     alert('success');
                        // },
                        // error:function (data) {
                        //     alert('error data '+JSON.stringify(data) )
                        // }
                    });
                }else{
                    alert('Not a valid image!');
                }
            }else{
                alert('Input something!');
            }
        }

        // function formatImageData(parent){
        //     var promises = [] ;
        //
        //     var dataformatted = generateDataFormat("listPicker");
        //
        //
        //     for(var i = 0 ; i <= next ; i++){
        //         var title = $('#'+parent+' #field-with-image'+i+' #title').val();
        //         var subtitle = $('#'+parent+' #field-with-image'+i+' #subtitle').val();
        //         var type = $('#'+parent+' #field-with-image'+i+' #type').val();
        //
        //         var file = $('.list-image')[0].files;
        //         var files = [];
        //         $('.list-image').each(function(el){
        //             files.push($(this)[0].files[0]);
        //         });
        //         console.log(files);
        //         var reader = new FileReader();
        //
        //         reader.onload = function(event) {
        //             console.log(event.target.result)
        //             // //console.log(event.target.result);
        //             // var data = {
        //             //     items : [
        //             //         {
        //             //             "identifier": "1",
        //             //             "order": 0,
        //             //             "imageIdentifier" : event.target.result,
        //             //             "style": "default",
        //             //             "subtitle": subtitle,
        //             //             "title": title
        //             //         },
        //             //         {
        //             //              "identifier": "1",
        //             //             "order": 0,
        //             //             "imageIdentifier" : event.target.result,
        //             //             "style": "default",
        //             //             "subtitle": subtitle,
        //             //             "title": title
        //             //         }
        //             //     ],
        //             //     order : i,
        //             //     "title" : type
        //             // };
        //             //
        //             // dataformatted.interactiveData.data.listPicker.sections.push(data);
        //
        //         };
        //         //promises.push(reader.onload);
        //         reader.readAsDataURL(file);
        //     }
        //
        //     $.when(promises).then(function(data){
        //         console.log(data[0]())
        //     })
        // }

        function formateData(parentSelector){

            var dataformatted = generateDataFormat("listPicker");
            var selector = parentSelector == "inputListtext" ?  "field" : "field-with-image";

            for(var i = 0 ; i <= next ; i++){
                var title = $('#'+selector+i+' #item_title').val();
                var subtitle = $('#'+selector+i+' #item_subtitle').val();
                var section = $('#'+selector+i+' #section_title').val();

                var data = {
                    items : [
                        {
                            "identifier": "1",
                            "order": 0,
                            "style": "default",
                            "subtitle": subtitle,
                            "title": title
                        }
                    ],
                    order : i,
                    "title" : section
                };
                dataformatted.interactiveData.data.listPicker.sections.push(data);

            }
            return dataformatted;
        }

        function formatApplePay(){
            var dataformatted = generateDataFormat("applyPay");
            var total = 0 ;

            for(var i = 0 ; i <= nextPay ; i++){
                var el = document.getElementById('pay pay0');
                var labelinput = $('#pay'+i+' #label').val();
                var amountinput = $('#pay'+i+' #amount').val();

                var data = {
                    label : labelinput ,
                    amount : parseFloat(amountinput),
                    type : "final"
                };
                total += data.amount ;

                dataformatted.interactiveData.data.payment.paymentRequest.lineItems.push(data);
            }
            dataformatted.interactiveData.data.payment.paymentRequest.total = {
                label : label ,
                amount : total,
                type : "final"
            }
            return dataformatted;
        }



        function cleanAfterSend(selector , incrementor){
            for(var i  = 1 ; i < incrementor ; i++){

            }
        }

        $(document).ready(function() {

            $(".add-more").click(function(){
                var html = $(".copy").html();
                $(".after-add-more").after(html);
            });


            $("body").on("click",".remove",function(){
                $(this).parents(".control-group").remove();
            });

            // submit list picker data
            $(".list-submit").click(function(e) {
                e.preventDefault();
                var data = formateData("inputListtext");
                console.log(data);
                sendData(data);
            });
            // function fileToDataURL(file){
            //     var reader = new FileReader();
            //     return new Promise(function (resolve, reject) {
            //       reader.onload = function (event) {
            //         resolve(event.target.result)
            //       }
            //       reader.readAsDataURL(file)
            //     })
            // }

            function fileToDataURL(file){
                console.log('fileToDataURL ... ');
                if(file != undefined){
                    console.log('file is un defined');
                    formData= new FormData();
                    if(!!file.type.match(/image.*/)){
                        formData.append("image", file);
                        return $.ajax({
                            url: "http://chatbots2.cequens.net/testupload?fileName="+file.name,
                            type: "POST",
                            data: formData,
                            processData: false,
                            contentType: false,
                            // success: function(data){
                            //     alert('success');
                            // },
                            // error:function (data) {
                            //     alert('error data '+JSON.stringify(data) )
                            // }
                        });
                    }else{
                        alert('Not a valid image!');
                    }
                }else{
                    alert('Input something!');
                }
                return Promise.resolve("http://chatbots2.cequens.net/"+file.name);
            }

            function readAsDataURL (target){
                console.log("target data "+target);
                return Promise.all(target.map(fileToDataURL));
            }
            $(".list-image-submit").click(function(e) {
                e.preventDefault();

                var data = formateData("inputListimage");
                var files = [];

                $('.list-image').each(function(el){
                    files.push($(this)[0].files[0]);
                });

                // readAsDataURL(files).then(function(res){
                //     res.map(function(item , index){
                //         data.interactiveData.data.listPicker.sections[index].items.map(function(row, index){
                //             row.imageIdentifier = item;
                //         })
                //     });
                //     console.log(data);
                //     sendData(data);
                // });
                files.map(function(item , index){
                    data.interactiveData.data.listPicker.sections[index].items.map(function(row, index){
                        //var formData  = new FormData();
                        //formData.append("fileGamed" , item);

                        row.imageIdentifier = "http://chatbots2.cequens.net/"+ item.name ;
                    })
                });
                sendData(data);

//                readAsDataURL(files).then(function(res){
//
//                    console.log("succceesss "+data);
//                })
//                    .catch(function(err){
//                        console.log("Exception "+JSON.stringify(err));
//                    })
//                    .finally(function () {
//
//                    });

            });

            // $('#inputListimage').submit(function(){
            //     var formData = new FormData(this);
            //     sendData(formData);
            // })



            $(".time-picker-submit").click(function(e) {
                e.preventDefault();

                var timePickerData = [];

                $('.time-picker').each(function(){
                    timePickerData.push(new Date($(this).val()));
                    //console.log($(this).val())
                })

                var data = formateDataTimePicker(timePickerData);
                console.log(data);
                sendData(data);
            });


            $('.send-attach-submit').click(function(e){
                e.preventDefault();

                var dataformatted = generateDataFormat("applyPay");



                var file = $("#b55").val();
                data = {
                    "messageType":"attachmentImage",
                    "id": "",
                    "type": "richLink",
                    "sourceId": "",
                    "destinationId": "",
                    "v": 1,
                    "body":"Here's the attachment: %s" ,
                    "richLinkData": [{
                        "url":"www.google.com",
                        "title": "Image Title",
                        "signature-base64": "",
                        "asset":[
                            {
                                "image": [
                                    {
                                        "data":file,
                                        "mimeType": "text"
                                    }
                                ]
                            }
                        ]
                    }]
                };
                sendData(data)
                // var reader = new FileReader();
                // reader.onload = function(event) {
                //     //console.log(event.target.result);
                //     console.log(event);
                //     var fileEncoded = event.target.result;
                //
                //     // data = {
                //     //     "id": "",
                //     //     "type": "text",
                //     //     "sourceId": "",
                //     //     "destinationId": "",
                //     //     "v": 1,
                //     //     "body":"Here's the attachment: %s" ,
                //     //     "attachments": [{
                //     //     "name":file.name,
                //     //     "mimeType": file.type,
                //     //     "size": file.size,
                //     //     "signature-base64": fileEncoded,
                //     //     "url": "",
                //     //     "owner": "",
                //     //     "key": ""
                //     //     }]
                //     // };
                //
                // };
                // reader.readAsDataURL(file);
            });

            $('.list-submit-apple-pay').click(function(e){
                e.preventDefault();

                var data = formatApplePay();
                console.log(data);
            })



            $("#add-more").click(function(e){
                e.preventDefault();
                var addto = "#field" + next;
                var addRemove = "#field" + (next);
                next = next + 1;
                var newIn = ' <div id="field'+ next +'" name="field'+ next +'">' +
                    '<!-- Text input-->' +
                    '<div class="form-group">' +
                    ' <label class="col-md-4 control-label" for="action_id">Section Title</label> ' +
                    '<div class="col-md-5"> ' +
                    '<input id="section_title" name="action_id" type="text" placeholder="" class="form-control input-md">' +
                    ' </div>' +
                    '</div>' +
                    '<br><br> ' +
                    '<!-- Text input-->' +
                    '<div class="form-group">' +
                    ' <label class="col-md-4 control-label" for="action_id">Item Title</label> ' +
                    '<div class="col-md-5"> ' +
                    '<input id="item_title" name="action_id" type="text" placeholder="" class="form-control input-md">' +
                    ' </div>' +
                    '</div>' +
                    '<br><br> ' +
                    '<!-- Text input-->' +
                    '<div class="form-group"> ' +
                    '<label class="col-md-4 control-label" for="action_name">Item Subtitle</label>' +
                    ' <div class="col-md-5">' +
                    ' <input id="item_subtitle" name="action_name" type="text" placeholder="" class="form-control input-md">' +
                    ' </div>' +
                    '</div>' +
                    '<br><br>' +
                    '</div>';
                var newInput = $(newIn);
                var removeBtn = '<button id="remove' + (next) + '" class="btn btn-danger remove-me" >Remove</button></div></div><div id="field">';
                var removeButton = $(removeBtn);
                $(addto).after(newInput);
                $(addRemove).after(removeButton);
                $("#field" + next).attr('data-source',$(addto).attr('data-source'));
                $("#count").val(next);

                $('.remove-me').click(function(e){
                    e.preventDefault();
                    var fieldNum = this.id.charAt(this.id.length-1);
                    var fieldID = "#field" + fieldNum;
                    $(this).remove();
                    $(fieldID).remove();
                    next--;
                });
            });

            $("#add-more-with-images").click(function(e){
                e.preventDefault();
                var addto = "#field-with-image" + next;
                var addRemove = "#field-with-image" + (next);
                next = next + 1;
                var newIn = ' <div id="field-with-image'+ next +'" name="field-with-image'+ next +'">' +
                    '<!-- Text input-->' +
                    '<div class="form-group">' +
                    ' <label class="col-md-4 control-label" for="action_id">Action Id</label> ' +
                    '<div class="col-md-5"> ' +
                    '<input id="section_title" name="action_id" type="text" placeholder="" class="form-control input-md">' +
                    ' </div>' +
                    '</div>' +
                    '<br><br> ' +
                    '<!-- Text input-->' +
                    '<div class="form-group"> ' +
                    '<label class="col-md-4 control-label" for="action_name">Item Title</label>' +
                    ' <div class="col-md-5">' +
                    ' <input id="item_title" name="action_name" type="text" placeholder="" class="form-control input-md">' +
                    ' </div>' +
                    '</div>' +
                    '<br><br>' +
                    '<!-- File Button --> ' +
                    '<div class="form-group">' +
                    ' <label class="col-md-4 control-label" for="action_json">Item Subtitle</label>' +
                    ' <div class="col-md-4">' +
                    ' <input id="item_subtitle" name="action_json" class="input-file" type="text"> ' +
                    '</div>' +
                    '</div>' +
                    '<!-- File Button --> ' +
                    ' <div class="form-group">\n'+
                    '                              <label class="col-md-4 control-label" for="action_json">Attachment</label>\n'+
                    '                              <div class="col-md-4">\n'+
                    '                              <input onchange="uploadFile(this)" type="file" id="image" name="action_json" class="input-file list-image" accept=".png,.jpg,.jpeg">\n'+
                    '                              </div>\n'+
                    '                              </div>' +
                    '</div>';
                var newInput = $(newIn);
                var removeBtn = '<button id="remove' + (next) + '" class="btn btn-danger remove-me" >Remove</button>';
                var removeButton = $(removeBtn);
                $("#field-with-image").append(newInput);
                $("#field-with-image").append(removeButton);
                // $(addto).after(newInput);
                // $(addRemove).after(removeButton);
                $("#field-with-image" + next).attr('data-source',$(addto).attr('data-source'));
                $("#count").val(next);

                $('.remove-me').click(function(e){
                    e.preventDefault();
                    var fieldNum = this.id.charAt(this.id.length-1);
                    var fieldID = "#field-with-image" + fieldNum;
                    $(this).remove();
                    $(fieldID).remove();
                    next--;
                });
            });

            $("#add-more-pay").click(function(e){
                e.preventDefault();
                var addto = "#pay" + nextPay;
                var addRemove = "#pay" + (nextPay);
                nextPay = nextPay + 1;
                var newIn =
                    ' <div id="pay'+ nextPay +'" name="pay'+ nextPay +'">' +
                    '<div class="form-group">' +
                    ' <label class="col-md-4 control-label" for="action_id">Action Id</label> ' +
                    '<div class="col-md-5"> ' +
                    '<input id="label" name="action_id" type="text" placeholder="" class="form-control input-md">' +
                    ' </div>' +
                    '</div>' +
                    '<br><br> ' +
                    '<div class="form-group"> ' +
                    '<label class="col-md-4 control-label" for="action_name">Action Name</label>' +
                    ' <div class="col-md-5">' +
                    ' <input id="amount" name="action_name" type="number" placeholder="" class="form-control input-md">' +
                    ' </div>' +
                    '</div>' +
                    '</div>';

                var newInput = $(newIn);
                var removeBtn = '<button id="remove' + (nextPay) + '" class="btn btn-danger remove-me" >Remove</button></div></div><div id="pay">';
                var removeButton = $(removeBtn);
                $("#pay").append(newInput);
                $("#pay").append(removeButton);
                //$("#pay" + nextPay).attr('data-source',$(addto).attr('data-source'));
                $("#count").val(nextPay);

                $('.remove-me').click(function(e){
                    e.preventDefault();
                    var fieldNum = this.id.charAt(this.id.length-1);
                    var fieldID = "#pay" + fieldNum;
                    $(this).remove();
                    $(fieldID).remove();
                    nextPay--;
                });
            });

        });


    </script>
{% endblock %}